name: Cleanup PR Environment

on:
  pull_request:
    types: [closed]

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  TF_VAR_admin_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_db_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}
  TF_VAR_gallery_name: ${{ vars.GALLERY_NAME }}
  TF_VAR_gallery_resource_group_name: ${{ vars.GALLERY_RESOURCE_GROUP }}
  TF_VAR_subnet_id: ${{ vars.SUBNET_ID }}

jobs:
  cleanup:
    name: Cleanup PR Resources
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      # Use a placeholder image version for destroy (required by variables but not used)
      - name: Set placeholder variables
        run: |
          echo "TF_VAR_image_version=cleanup-placeholder" >> $GITHUB_ENV

      # Destroy Test VM first (if exists)
      - name: Destroy Test Environment
        working-directory: environments/test
        continue-on-error: true
        run: |
          terraform init
          terraform destroy -auto-approve \
            -var="pr_number=${{ github.event.pull_request.number }}" || true

      # Destroy Dev environment (PostgreSQL + VM + Resource Group)
      - name: Destroy Dev Environment
        working-directory: environments/dev
        run: |
          terraform init
          terraform destroy -auto-approve \
            -var="pr_number=${{ github.event.pull_request.number }}"

      - name: Cleanup Summary
        run: |
          echo "## PR Environment Cleaned Up" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Destroyed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dev/Test Resource Group" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL Flexible Server" >> $GITHUB_STEP_SUMMARY
          echo "- Dev and Test VMs" >> $GITHUB_STEP_SUMMARY

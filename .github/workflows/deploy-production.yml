name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_version:
        description: 'Image version to deploy'
        required: true
        type: string

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  TF_VAR_admin_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_gallery_name: ${{ vars.GALLERY_NAME }}
  TF_VAR_gallery_resource_group_name: ${{ vars.GALLERY_RESOURCE_GROUP }}
  TF_VAR_subnet_id: ${{ vars.PROD_SUBNET_ID }}

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: environments/production
        run: terraform init

      - name: Terraform Plan
        working-directory: environments/production
        run: |
          terraform plan \
            -var="image_version=${{ github.event.inputs.image_version }}" \
            -out=tfplan

      - name: Terraform Apply (Rolling Update)
        working-directory: environments/production
        run: terraform apply -auto-approve tfplan

      - name: Get VMSS Details
        id: vmss
        working-directory: environments/production
        run: |
          echo "vmss_name=$(terraform output -raw vmss_name)" >> $GITHUB_OUTPUT
          echo "vmss_id=$(terraform output -raw vmss_id)" >> $GITHUB_OUTPUT

      - name: Monitor Rolling Update
        env:
          VMSS_NAME: ${{ steps.vmss.outputs.vmss_name }}
        run: |
          echo "Monitoring rolling update for VMSS: $VMSS_NAME"

          # Get resource group
          RG_NAME=$(terraform -chdir=environments/production output -raw resource_group_name)

          # Monitor upgrade status
          for i in {1..60}; do
            STATUS=$(az vmss get-instance-view \
              --name $VMSS_NAME \
              --resource-group $RG_NAME \
              --query "statuses[?code=='ProvisioningState/succeeded'].code" \
              -o tsv 2>/dev/null || echo "pending")

            if [ "$STATUS" == "ProvisioningState/succeeded" ]; then
              echo "Rolling update completed successfully!"
              exit 0
            fi

            echo "Update in progress... (check $i/60)"
            sleep 30
          done

          echo "Warning: Rolling update monitoring timed out"

      - name: Deployment Summary
        run: |
          echo "## Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Version:** ${{ github.event.inputs.image_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**VMSS:** ${{ steps.vmss.outputs.vmss_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rolling update initiated. Monitor Azure portal for completion status." >> $GITHUB_STEP_SUMMARY

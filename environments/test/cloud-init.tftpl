#cloud-config

# This cloud-init configuration is applied at VM boot time
# It sets up the database connection for the Drupal application
# Uses the same PostgreSQL instance as the dev environment

write_files:
  # Database connection environment file
  - path: /etc/drupal/database.env
    permissions: '0600'
    owner: root:drupal
    content: |
      # PostgreSQL connection settings
      # Generated by Terraform for test environment
      # Using shared dev/test PostgreSQL instance
      DRUPAL_DB_HOST=${db_host}
      DRUPAL_DB_PORT=5432
      DRUPAL_DB_NAME=${db_name}
      DRUPAL_DB_USER=${db_user}
      DRUPAL_DB_PASSWORD=${db_password}
      DRUPAL_DB_SSL=require

  # Drupal settings.php include file
  - path: /etc/drupal/settings.database.php
    permissions: '0640'
    owner: root:drupal
    content: |
      <?php
      /**
       * Database configuration for Drupal
       * Auto-generated by Terraform cloud-init (test environment)
       */
      $databases['default']['default'] = [
        'database' => '${db_name}',
        'username' => '${db_user}',
        'password' => '${db_password}',
        'host' => '${db_host}',
        'port' => '5432',
        'driver' => 'pgsql',
        'prefix' => '',
        'pdo' => [
          \PDO::ATTR_SSL_VERIFY_SERVER_CERT => TRUE,
        ],
      ];

runcmd:
  # Ensure drupal group exists and has access to config directory
  - groupadd -f drupal
  - chown -R root:drupal /etc/drupal
  - chmod 750 /etc/drupal

  # Add IP address pattern to trusted hosts for dev/test access
  # This allows accessing the site via raw IP address
  - |
    if [ -f /etc/drupal/environment.php ]; then
      # Add IP pattern before the closing of trusted_host_patterns array
      sed -i "/^\$trusted_host_patterns = \[/a\  '^[0-9]+\\\.[0-9]+\\\.[0-9]+\\\.[0-9]+\$'," /etc/drupal/environment.php
      echo "Added IP address pattern to trusted_host_patterns" >> /var/log/cloud-init-output.log
    fi

  # Log that cloud-init completed
  - echo "Cloud-init database configuration complete (test environment)" >> /var/log/cloud-init-output.log

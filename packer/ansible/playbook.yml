---
- name: Configure Drupal application server
  hosts: all
  become: true

  vars:
    php_version: "{{ php_version | default('8.3') }}"
    drupal_user: "drupal"
    drupal_group: "drupal"
    web_root: "/var/www/drupal"
    drupal_env: "{{ drupal_env | default('production') }}"
    drupal_version: "11"
    s3proxy_version: "2.6.0"
    s3proxy_user: "s3proxy"
    s3proxy_group: "s3proxy"
    s3proxy_home: "/opt/s3proxy"

  tasks:
    # System updates and EPEL repository
    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true

    - name: Install EPEL repository
      ansible.builtin.dnf:
        name: epel-release
        state: present

    # Remi repository for PHP
    - name: Install Remi repository
      ansible.builtin.dnf:
        name: "https://rpms.remirepo.net/enterprise/remi-release-9.rpm"
        state: present
        disable_gpg_check: true

    - name: Reset PHP module
      ansible.builtin.command: dnf module reset php -y
      changed_when: true

    - name: Enable PHP {{ php_version }} module from Remi
      ansible.builtin.command: "dnf module enable php:remi-{{ php_version }} -y"
      changed_when: true

    # Install packages
    - name: Install required packages
      ansible.builtin.dnf:
        name:
          # Web server
          - httpd
          - mod_ssl
          # PHP and extensions
          - php
          - php-fpm
          - php-cli
          - php-common
          - php-pdo
          - php-pgsql
          - php-mysqlnd
          - php-gd
          - php-mbstring
          - php-xml
          - php-json
          - php-opcache
          - php-curl
          - php-zip
          - php-intl
          - php-bcmath
          - php-soap
          # Development tools
          - git
          - unzip
          - patch
          # Database client
          - postgresql
          # Utilities
          - vim-enhanced
          - htop
          - curl
          - wget
          # Java for S3Proxy
          - java-11-openjdk-headless
        state: present

    # Install Composer
    - name: Download Composer installer
      ansible.builtin.get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php
        mode: "0644"

    - name: Install Composer globally
      ansible.builtin.command: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer

    - name: Remove Composer installer
      ansible.builtin.file:
        path: /tmp/composer-setup.php
        state: absent

    # Create Drupal user and group
    - name: Create drupal group
      ansible.builtin.group:
        name: "{{ drupal_group }}"
        system: true
        state: present

    - name: Create drupal user
      ansible.builtin.user:
        name: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        groups: apache
        create_home: true
        home: "/home/{{ drupal_user }}"
        shell: /bin/bash
        system: true
        state: present

    - name: Add apache user to drupal group
      ansible.builtin.user:
        name: apache
        groups: "{{ drupal_group }}"
        append: true

    # Create web root directory (Drupal will be installed here via Composer)
    - name: Create web root directory
      ansible.builtin.file:
        path: "{{ web_root }}"
        state: directory
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0755"

    # Configure PHP-FPM
    - name: Configure PHP-FPM pool for Drupal
      ansible.builtin.template:
        src: templates/php-fpm-drupal.conf.j2
        dest: /etc/php-fpm.d/drupal.conf
        mode: "0644"
      notify: restart php-fpm

    - name: Remove default PHP-FPM www pool
      ansible.builtin.file:
        path: /etc/php-fpm.d/www.conf
        state: absent
      notify: restart php-fpm

    # Configure PHP
    - name: Configure PHP settings
      ansible.builtin.lineinfile:
        path: /etc/php.ini
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: "^memory_limit", line: "memory_limit = 256M" }
        - { regexp: "^upload_max_filesize", line: "upload_max_filesize = 64M" }
        - { regexp: "^post_max_size", line: "post_max_size = 64M" }
        - { regexp: "^max_execution_time", line: "max_execution_time = 300" }
        - { regexp: "^;?date.timezone", line: "date.timezone = UTC" }
      notify: restart php-fpm

    # Configure Apache
    - name: Configure Apache for Drupal
      ansible.builtin.template:
        src: templates/apache-drupal.conf.j2
        dest: /etc/httpd/conf.d/drupal.conf
        mode: "0644"
      notify: restart httpd

    - name: Remove default Apache welcome page
      ansible.builtin.file:
        path: /etc/httpd/conf.d/welcome.conf
        state: absent
      notify: restart httpd

    - name: Disable default SSL configuration
      ansible.builtin.file:
        path: /etc/httpd/conf.d/ssl.conf
        state: absent
      notify: restart httpd

    # Create environment config directory
    - name: Create Drupal config directory
      ansible.builtin.file:
        path: /etc/drupal
        state: directory
        owner: root
        group: "{{ drupal_group }}"
        mode: "0750"

    # Install Drupal via Composer
    - name: Install Drupal project via Composer
      ansible.builtin.command:
        cmd: /usr/local/bin/composer create-project drupal/recommended-project:^{{ drupal_version }} .
        chdir: "{{ web_root }}"
        creates: "{{ web_root }}/composer.json"
      become: true
      become_user: "{{ drupal_user }}"
      environment:
        COMPOSER_HOME: "/tmp/composer-{{ drupal_user }}"

    - name: Install Drush
      ansible.builtin.command:
        cmd: /usr/local/bin/composer require drush/drush
        chdir: "{{ web_root }}"
      become: true
      become_user: "{{ drupal_user }}"
      environment:
        COMPOSER_HOME: "/tmp/composer-{{ drupal_user }}"
      args:
        creates: "{{ web_root }}/vendor/bin/drush"

    - name: Install S3FS module for Azure Blob Storage integration
      ansible.builtin.command:
        cmd: /usr/local/bin/composer require drupal/s3fs
        chdir: "{{ web_root }}"
      become: true
      become_user: "{{ drupal_user }}"
      environment:
        COMPOSER_HOME: "/tmp/composer-{{ drupal_user }}"
      args:
        creates: "{{ web_root }}/web/modules/contrib/s3fs"

    - name: Create Drupal files directory
      ansible.builtin.file:
        path: "{{ web_root }}/web/sites/default/files"
        state: directory
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0775"

    - name: Create Drupal private files directory
      ansible.builtin.file:
        path: "{{ web_root }}/private"
        state: directory
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0770"

    - name: Create Drupal config sync directory
      ansible.builtin.file:
        path: "{{ web_root }}/config/sync"
        state: directory
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0775"

    - name: Copy default settings.php
      ansible.builtin.copy:
        src: "{{ web_root }}/web/sites/default/default.settings.php"
        dest: "{{ web_root }}/web/sites/default/settings.php"
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0644"
        remote_src: true
        force: false

    - name: Add environment-based configuration to settings.php
      ansible.builtin.blockinfile:
        path: "{{ web_root }}/web/sites/default/settings.php"
        marker: "# {mark} ANSIBLE MANAGED - Environment Configuration"
        block: |
          /**
           * Load database credentials from environment config file.
           * This file is populated by cloud-init at boot time.
           */
          $drupal_env_file = '/etc/drupal/environment.php';
          if (file_exists($drupal_env_file)) {
            require_once $drupal_env_file;
          }

          /**
           * Config sync directory.
           */
          $settings['config_sync_directory'] = '../config/sync';

          /**
           * Private file path.
           */
          $settings['file_private_path'] = '../private';

          /**
           * Trusted host patterns - configured via environment.php
           */
          if (isset($trusted_host_patterns)) {
            $settings['trusted_host_patterns'] = $trusted_host_patterns;
          }

          /**
           * Hash salt - must be set via environment.php
           */
          if (isset($hash_salt)) {
            $settings['hash_salt'] = $hash_salt;
          }

    - name: Create environment.php placeholder
      ansible.builtin.template:
        src: templates/drupal-environment.php.j2
        dest: /etc/drupal/environment.php
        owner: root
        group: "{{ drupal_group }}"
        mode: "0640"

    - name: Create symlink for drush
      ansible.builtin.file:
        src: "{{ web_root }}/vendor/bin/drush"
        dest: /usr/local/bin/drush
        state: link

    # Create health check endpoint (after Drupal web directory exists)
    - name: Create health check endpoint
      ansible.builtin.copy:
        content: "OK"
        dest: "{{ web_root }}/web/health"
        owner: "{{ drupal_user }}"
        group: "{{ drupal_group }}"
        mode: "0644"

    # Enable and start services
    - name: Enable httpd service
      ansible.builtin.systemd:
        name: httpd
        enabled: true

    - name: Enable php-fpm service
      ansible.builtin.systemd:
        name: php-fpm
        enabled: true

    # Firewall configuration
    - name: Install firewalld
      ansible.builtin.dnf:
        name: firewalld
        state: present

    - name: Enable firewalld
      ansible.builtin.systemd:
        name: firewalld
        enabled: true
        state: started

    - name: Open HTTP port
      ansible.posix.firewalld:
        port: 80/tcp
        permanent: true
        state: enabled
        immediate: true

    - name: Open HTTPS port
      ansible.posix.firewalld:
        port: 443/tcp
        permanent: true
        state: enabled
        immediate: true

    # S3Proxy installation (for Azure Blob Storage integration via S3 API)
    - name: Create s3proxy group
      ansible.builtin.group:
        name: "{{ s3proxy_group }}"
        system: true
        state: present

    - name: Create s3proxy user
      ansible.builtin.user:
        name: "{{ s3proxy_user }}"
        group: "{{ s3proxy_group }}"
        create_home: false
        shell: /sbin/nologin
        system: true
        state: present

    - name: Create S3Proxy directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ s3proxy_user }}"
        group: "{{ s3proxy_group }}"
        mode: "0755"
      loop:
        - "{{ s3proxy_home }}"
        - "{{ s3proxy_home }}/data"
        - /etc/s3proxy

    - name: Download S3Proxy JAR
      ansible.builtin.get_url:
        url: "https://github.com/gaul/s3proxy/releases/download/s3proxy-{{ s3proxy_version }}/s3proxy"
        dest: "{{ s3proxy_home }}/s3proxy.jar"
        owner: "{{ s3proxy_user }}"
        group: "{{ s3proxy_group }}"
        mode: "0644"

    - name: Create S3Proxy systemd service
      ansible.builtin.template:
        src: templates/s3proxy.service.j2
        dest: /etc/systemd/system/s3proxy.service
        mode: "0644"
      notify: reload systemd

    - name: Create S3Proxy environment file placeholder
      ansible.builtin.copy:
        content: |
          # S3Proxy environment configuration
          # This file is populated by cloud-init at boot with storage account credentials
          # JCLOUDS_PROVIDER=azureblob
          # JCLOUDS_IDENTITY=<storage_account_name>
          # JCLOUDS_CREDENTIAL=<storage_account_key>
          # JCLOUDS_ENDPOINT=https://<storage_account_name>.blob.core.windows.net
          # S3PROXY_AUTHORIZATION=none
        dest: /etc/s3proxy/s3proxy.env
        owner: root
        group: "{{ s3proxy_group }}"
        mode: "0640"

    - name: Enable s3proxy service (will start after cloud-init configures it)
      ansible.builtin.systemd:
        name: s3proxy
        enabled: true
        daemon_reload: true

    # SELinux configuration
    - name: Install SELinux policy tools
      ansible.builtin.dnf:
        name:
          - policycoreutils-python-utils
          - setools-console
        state: present

    - name: Set SELinux context for web root
      community.general.sefcontext:
        target: "{{ web_root }}(/.*)?"
        setype: httpd_sys_rw_content_t
        state: present

    - name: Apply SELinux context
      ansible.builtin.command: "restorecon -Rv {{ web_root }}"
      changed_when: true

    - name: Allow httpd to connect to network
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true

    - name: Allow httpd to connect to database
      ansible.posix.seboolean:
        name: httpd_can_network_connect_db
        state: true
        persistent: true

  handlers:
    - name: restart php-fpm
      ansible.builtin.systemd:
        name: php-fpm
        state: restarted

    - name: restart httpd
      ansible.builtin.systemd:
        name: httpd
        state: restarted

    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
